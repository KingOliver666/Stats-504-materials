```{r}
library(ggplot2)
library(stringr)
library(purrr)
library(dplyr)
```

```{r}
source("prep.R")
```

Only consider counties for which we have natality data.

```{r}
fips = unique(births$FIPS)
demog = demog %>% filter(FIPS %in% fips)
```

```{r}
dl = pivot_longer(select(demog, -FIPS), cols=everything(), names_to="group", values_to="population")
dl = separate(dl, group, c("race", "ethnicity", "sex", "age"), sep="_")
ds = group_by(dl, race, ethnicity, sex) %>% summarize(population=sum(population))
print(ds, n=Inf)
print(sum(ds$population))
```

Fourth root transform the population counts for variance stabilization and symmetry.

```{r}
demogx = demog %>% mutate(across(-FIPS, function(x)x^0.25))
```

Create a data matrix omitting the FIPS index column

```{r}
demogx = demogx %>% select(-FIPS)
demogx = as.matrix(demogx)
```

Double center the data

```{r}
demogx = demogx - mean(demogx)
demogx = scale(demogx, scale=F)
demogx = t(scale(t(demogx), scale=F))
```

Factor the matrix

```{r}
ss = svd(demogx)
```

Extract the components of the SVD

```{r}
u = ss$u
s = ss$d
v = ss$v
```

Plot the singular values to assess the dimensionality:

```{r}
dp = data.frame(x=seq(length(s)), y=s)
plt = ggplot(data=dp, aes(x=x, y=y)) + geom_line() + geom_point()
plt = plt + xlab("Position") + ylab("Singular value")
print(plt)
```
Consider exponential and power law models for the singular values, by making scree plots in semi-log space and log space.  One reasonable interpretation of these plots is that there are around 10-12 relatively larger singular values, and the remainder follow an exponential pattern.

```{r}
ss = s[1:(length(s)-1)]
dp = data.frame(x=seq(length(ss)), y=ss)
plt = ggplot(data=dp, aes(x=x, y=log(y))) + geom_line() + geom_point()
plt = plt + xlab("Position") + ylab("Log singular value")
plt = plt + ggtitle("Assess fit for exponential model ")
print(plt)
```
```{r}
plt = ggplot(data=dp, aes(x=log(x), y=log(y))) + geom_line() + geom_point()
plt = plt + xlab("Log position") + ylab("Log singular value")
plt = plt + ggtitle("Assess fit for powerlaw model ")
print(plt)
```

Construct the row and column scores

```{r}
#alpha = 1 # distance interpretation for rows (counties)
#alpha = 0 # distance interpretation for columns (demographic categories)
alpha = 0.5
uu = u %*% diag(s^alpha)
vv = v %*% diag(s^(1-alpha))
```

Remove outlier counties to make the plot easier to read

```{r}
iqr = function(x){ quantile(x, 0.75) - quantile(x, 0.25) }
for (j in 1:2) {
    ii = abs(uu[,j] - median(uu[,j])) < 4*iqr(uu[,j])
    uu = uu[ii,]
}
```

```{r}
generate_biplots = function(uu, vv, sx, j1, j2) {
  cn = names(demog)
  cx = str_split(cn, "_")
  cx = cx[2:length(cx)]

  ud = data.frame(u1=uu[,j1], u2=uu[,j2])
  vd = data.frame(v1=vv[,j1], v2=vv[,j2], race=cx%>%map(1)%>%list_simplify, eth=cx%>%map(2)%>%as_vector, sex=cx%>%map(3)%>%as_vector)
  vd1 = vd %>% filter(sex==sx)

  # Plot grey points for the counties
  plt = ggplot(data=ud, aes(x=u1, y=u2)) + geom_point(alpha=0.2)

  # Plot colored points for the demographic variables
  plt = plt + geom_path(data=vd1, aes(x=v1, y=v2, group=interaction(race, eth), color=interaction(race, eth)))

  plt = plt + xlab(sprintf("Component %d", j1)) + ylab(sprintf("Component %d", j2))
  plt = plt + ggtitle(ifelse(sx=="F", "Female", "Male"))
  print(plt)
}
```

```{r}
generate_biplots(uu, vv, "F", 1, 2)
```

```{r}
generate_biplots(uu, vv, "M", 1, 2)
```

```{r}
generate_biplots(uu, vv, "F", 3, 4)
```

```{r}
generate_biplots(uu, vv, "M", 3, 4)
```